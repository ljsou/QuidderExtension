/** * Created by Javier on 29/10/03. */var ip = "localhost";var postUrl = "http://" + ip + ":8084/QuidderExServer/faces/index.xhtml";var getUrl = "http://" + ip + ":8084/QuidderExServer/faces/index.xhtml";// This callback function is called when the content script has been// injected and returned its resultsfunction onPageInfo(o)  {    console.log("popup - onPageInfo");    //document.getElementById("currentLink").value = o.title;    document.getElementById("url").value = o.url;    document.getElementById("summary").innerText = o.summary;}// When the popup HTML has loadedwindow.addEventListener("load", function(evt) {    console.log("popup - addEventListener");    // Handle the bookmark form submit event with our addBookmark function    if(localStorage.getItem('pin') != null){        document.getElementById('save').addEventListener('click', function(){            //var newURL = "http://localhost:8084/QuidderExServer/faces/index.xhtml   ";            //chrome.tabs.create({ url: newURL });            addBookmark();        });    }    document.getElementById('submitsingup').addEventListener('click', function(){        initSingUp();    });    document.getElementById('getpin').addEventListener('click', function(){        var newURL = "http://" + ip + ":8084/QuidderExServer/faces/Register.xhtml";        chrome.tabs.create({ url: newURL });    });    // Call the getPageInfo function in the background page, injecting content_script.js    // into the current HTML page and passing in our onPageInfo function as the callback    //chrome.extension.getBackgroundPage().getPageInfo(onPageInfo);});// POST the data to the server using XMLHttpRequestfunction initSingUp() {    console.log("popup - initSingUp");    var xhrInit = new XMLHttpRequest();    // xhr.open("POST", postUrl, true);    // Non-asynchronous request works fine    xhrInit.open("POST", postUrl, false);    var user =  "&pin=" + document.getElementById("userID").value;    localStorage.setItem('pin', user);    xhrInit.setRequestHeader("Content-type", "application/x-www-form-urlencoded");    xhrInit.send(user);    var xhReqInit = new XMLHttpRequest();    xhReqInit.open("GET", getUrl, false);    // This async request used to work, but now doesn't for some reason...    // It works if you 'Inspect popup' and step through the code in the Chrome debugger,    // but as soon as you close the debugger and try the same thing, the call fails?!??    xhReqInit.onreadystatechange = function() {        // If the request completed, close the extension popup        console.log(xhReqInit.readyState);        if (xhReqInit.readyState == 4) {            console.log(xhReqInit.status);            if(xhReqInit.status == 202){                var serverResponse = xhReqInit.statusText;                alert("Server response (202): " + xhReqInit.getResponseHeader("Acepted"));                chrome.browserAction.setPopup({                    popup:"TaggingBox.html"                });                window.close();            }if(xhReqInit.status == 200){                alert("Server response (200): " + xhReqInit.getResponseHeader("Info"));                console.log("Server response (200): " + xhReqInit.statusText + " a header:  " + xhReqInit.getResponseHeader("Info"));                chrome.browserAction.setPopup({                    popup:"TaggingBox.html"                });                window.close();            }if(xhReqInit.status == 401){                alert("Server response (401): " + xhReqInit.getResponseHeader("Warning"));                //console.log("status: " + xhReqInit.statusText);                if(localStorage.getItem('pin') != null){                    localStorage.removeItem("pin");                }            }        }    };    xhReqInit.send();    //window.close();    return false;}// POST the data to the server using XMLHttpRequestfunction addBookmark() {    console.log("popup - addBookmark");    var xhr = new XMLHttpRequest();    // xhr.open("POST", postUrl, true);    // Non-asynchronous request works fine    xhr.open("POST", postUrl, false);    var params = localStorage.getItem('pin') + "&url=" + document.getElementById("url").value +        "&summary=" + document.getElementById("summary").value;    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");    xhr.send(params);    var xhReq = new XMLHttpRequest();    xhReq.open("GET", getUrl, false);    // This async request used to work, but now doesn't for some reason...    // It works if you 'Inspect popup' and step through the code in the Chrome debugger,    // but as soon as you close the debugger and try the same thing, the call fails?!??    xhReq.onreadystatechange = function() {        // If the request completed, close the extension popup        console.log(xhReq.readyState);        if (xhReq.readyState == 4) {            console.log(xhReq.status);            if (xhReq.status == 200){                var serverResponse = xhReq.statusText;                console.log(serverResponse);                alert("Server response (200): " + xhReq.getResponseHeader("Info"));                window.close();            }if(xhReq.status == 401){                alert("Server response (401): " + xhReq.getResponseHeader("Warning"));            }        }    };    xhReq.send();    //window.close();    return false;}